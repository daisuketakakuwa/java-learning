# 流れで理解する。

1. ログイン画面で Username/Password を入力 -> /POST login で認証 まで既存クラスでいけるかな。
2. HttpSecurity.formLogin() で SpringBoot 提供のログイン画面使えるね(※Customize 可能)
3. [UsernamePasswordAuthenticationFilter](https://github.com/spring-projects/spring-security/blob/main/web/src/main/java/org/springframework/security/web/authentication/UsernamePasswordAuthenticationFilter.java) クラスを Filter として登録すると、**POST /login に対してのみ**Filter 処理が走る。
4. 3 内部で Username をキーに ユーザー情報を取得＆認証してくれる [AuthenticationManager\<IF\>を呼び出してる](https://github.com/spring-projects/spring-security/blob/main/web/src/main/java/org/springframework/security/web/authentication/UsernamePasswordAuthenticationFilter.java#L85)な。
5. 4 の実装クラスで [ProviderManager](https://github.com/spring-projects/spring-security/blob/main/core/src/main/java/org/springframework/security/authentication/ProviderManager.java) クラスがあって、こいつは既に Spring で完成されてるクラスなんだな。実際こいつは Manager という名の通り旗振りしているだけで、ユーザー情報取得＆認証をになっている[AuthenticationProvider\<IF\>を呼び出してる](https://github.com/spring-projects/spring-security/blob/main/core/src/main/java/org/springframework/security/authentication/ProviderManager.java#L182)ね。
6. AuthenticationProvider\<IF\>の実装クラスはいくつかあって、その１つが DaoAuthenticationProvider\<IMPL\>。
7. DaoAuthenticationProvider\<IMPL\>は、UserDetailsService\<IF\>の[loadUserByUsername 関数を呼び出して](https://github.com/spring-projects/spring-security/blob/main/core/src/main/java/org/springframework/security/authentication/dao/DaoAuthenticationProvider.java#L103)UserDetails\<IF\>(ユーザ情報)を取得している。
8. 7 で取得したユーザー情報を[PasswordEncoder\<IF\>.matches(String raw, String encoded)関数で認証](https://github.com/spring-projects/spring-security/blob/main/core/src/main/java/org/springframework/security/authentication/dao/DaoAuthenticationProvider.java#L86)している。
9. 7(ユーザ情報取得)->8(認証)が OK であれば、DaoAuthenticationProvider は [createSuccessAuthentication 関数](https://github.com/spring-projects/spring-security/blob/main/core/src/main/java/org/springframework/security/authentication/dao/DaoAuthenticationProvider.java#L123-L132)で認証済情報([Authentication\<IF\>](https://github.com/spring-projects/spring-security/blob/main/core/src/main/java/org/springframework/security/core/Authentication.java))を作成して返す。
10. Manager は 9 の Authentication を受け取り、呼び出し元の UsernamePasswordAuthenticationFilter に返す。
11. 最後に [SecurityContext へ保存](https://github.com/spring-projects/spring-security/blob/main/web/src/main/java/org/springframework/security/web/authentication/AbstractAuthenticationProcessingFilter.java#L322-L323)して終了！

<br>
<br>

# 図にしてみた

✅ UsernamePasswordAuthenticationFilter クラスを追加すると、POST /login が公開される。<br>
✅✅✅**ログイン用 Endpoint を既存クラスで Cover したい -> この Filter 使う**✅✅✅<br>
✅ ユーザ情報取得 -> UserDetailsService\<IF\>.loadUserByUsername 関数<br>
✅ パスワード認証 -> PasswordEncoder\<IF\>.matches 関数<br>
🔴 こう見ると...Manager、Provider はただの通過地点みたいな感じ。

![](https://storage.googleapis.com/zenn-user-upload/867fbf0bcddd-20231103.png)

<details>
<summary>generated by sequencediagram</summary>
LoginPage->Filter:POST /login<br>
Filter->Manager:authenticate(Authentication)<br>
Manager->Provider:authenticate(Authentication)<br>
Provider->UserDetailsService:loadUserByUsername()<br>
UserDetailsService->Provider:UserDetails<br>
Provider->PasswordEncoder:matches()<br>
PasswordEncoder->Provider:OK!<br>
Provider->Manager:Authentication<br>
Manager->Filter:Authentication<br>
Filter->Filter:SecurityContextに保存<br>
Filter->LoginPage:認証OK
</details>

<br>
<br>

# IF -> IMPL

| IF                        | IMPL                                                                                          |
| ------------------------- | --------------------------------------------------------------------------------------------- |
| Filter, GenericFilterBean | UsernamePasswordAuthenticationFilter                                                          |
| AuthenticationManager     | ProviderManager                                                                               |
| AuthenticationProvider    | DaoAuthenticationProvider<br>OpenIDAuthenticationProvider<br>RememberMeAuthenticationProvider |
