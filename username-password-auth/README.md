# æµã‚Œã§ç†è§£ã™ã‚‹ã€‚

1. ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã§ Username/Password ã‚’å…¥åŠ› -> /POST login ã§èªè¨¼ ã¾ã§æ—¢å­˜ã‚¯ãƒ©ã‚¹ã§ã„ã‘ã‚‹ã‹ãªã€‚
2. HttpSecurity.formLogin() ã§ SpringBoot æä¾›ã®ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ä½¿ãˆã‚‹ã­(â€»Customize å¯èƒ½)
3. [UsernamePasswordAuthenticationFilter](https://github.com/spring-projects/spring-security/blob/main/web/src/main/java/org/springframework/security/web/authentication/UsernamePasswordAuthenticationFilter.java) ã‚¯ãƒ©ã‚¹ã‚’ Filter ã¨ã—ã¦ç™»éŒ²ã™ã‚‹ã¨ã€**POST /login ã«å¯¾ã—ã¦ã®ã¿**Filter å‡¦ç†ãŒèµ°ã‚‹ã€‚
4. 3 å†…éƒ¨ã§ Username ã‚’ã‚­ãƒ¼ã« ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ï¼†èªè¨¼ã—ã¦ãã‚Œã‚‹ [AuthenticationManager\<IF\>ã‚’å‘¼ã³å‡ºã—ã¦ã‚‹](https://github.com/spring-projects/spring-security/blob/main/web/src/main/java/org/springframework/security/web/authentication/UsernamePasswordAuthenticationFilter.java#L85)ãªã€‚
5. 4 ã®å®Ÿè£…ã‚¯ãƒ©ã‚¹ã§ [ProviderManager](https://github.com/spring-projects/spring-security/blob/main/core/src/main/java/org/springframework/security/authentication/ProviderManager.java) ã‚¯ãƒ©ã‚¹ãŒã‚ã£ã¦ã€ã“ã„ã¤ã¯æ—¢ã« Spring ã§å®Œæˆã•ã‚Œã¦ã‚‹ã‚¯ãƒ©ã‚¹ãªã‚“ã ãªã€‚å®Ÿéš›ã“ã„ã¤ã¯ Manager ã¨ã„ã†åã®é€šã‚Šæ——æŒ¯ã‚Šã—ã¦ã„ã‚‹ã ã‘ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ï¼†èªè¨¼ã‚’ã«ãªã£ã¦ã„ã‚‹[AuthenticationProvider\<IF\>ã‚’å‘¼ã³å‡ºã—ã¦ã‚‹](https://github.com/spring-projects/spring-security/blob/main/core/src/main/java/org/springframework/security/authentication/ProviderManager.java#L182)ã­ã€‚
6. AuthenticationProvider\<IF\>ã®å®Ÿè£…ã‚¯ãƒ©ã‚¹ã¯ã„ãã¤ã‹ã‚ã£ã¦ã€ãã®ï¼‘ã¤ãŒ DaoAuthenticationProvider\<IMPL\>ã€‚
7. DaoAuthenticationProvider\<IMPL\>ã¯ã€UserDetailsService\<IF\>ã®[loadUserByUsername é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦](https://github.com/spring-projects/spring-security/blob/main/core/src/main/java/org/springframework/security/authentication/dao/DaoAuthenticationProvider.java#L103)UserDetails\<IF\>(ãƒ¦ãƒ¼ã‚¶æƒ…å ±)ã‚’å–å¾—ã—ã¦ã„ã‚‹ã€‚
8. 7 ã§å–å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’[PasswordEncoder\<IF\>.matches(String raw, String encoded)é–¢æ•°ã§èªè¨¼](https://github.com/spring-projects/spring-security/blob/main/core/src/main/java/org/springframework/security/authentication/dao/DaoAuthenticationProvider.java#L86)ã—ã¦ã„ã‚‹ã€‚
9. 7(ãƒ¦ãƒ¼ã‚¶æƒ…å ±å–å¾—)->8(èªè¨¼)ãŒ OK ã§ã‚ã‚Œã°ã€DaoAuthenticationProvider ã¯ [createSuccessAuthentication é–¢æ•°](https://github.com/spring-projects/spring-security/blob/main/core/src/main/java/org/springframework/security/authentication/dao/DaoAuthenticationProvider.java#L123-L132)ã§èªè¨¼æ¸ˆæƒ…å ±([Authentication\<IF\>](https://github.com/spring-projects/spring-security/blob/main/core/src/main/java/org/springframework/security/core/Authentication.java))ã‚’ä½œæˆã—ã¦è¿”ã™ã€‚
10. Manager ã¯ 9 ã® Authentication ã‚’å—ã‘å–ã‚Šã€å‘¼ã³å‡ºã—å…ƒã® UsernamePasswordAuthenticationFilter ã«è¿”ã™ã€‚
11. æœ€å¾Œã« [SecurityContext ã¸ä¿å­˜](https://github.com/spring-projects/spring-security/blob/main/web/src/main/java/org/springframework/security/web/authentication/AbstractAuthenticationProcessingFilter.java#L322-L323)ã—ã¦çµ‚äº†ï¼

<br>
<br>

# å›³ã«ã—ã¦ã¿ãŸ

âœ… UsernamePasswordAuthenticationFilter ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã™ã‚‹ã¨ã€POST /login ãŒå…¬é–‹ã•ã‚Œã‚‹ã€‚<br>
âœ…âœ…âœ…**ãƒ­ã‚°ã‚¤ãƒ³ç”¨ Endpoint ã‚’æ—¢å­˜ã‚¯ãƒ©ã‚¹ã§ Cover ã—ãŸã„ -> ã“ã® Filter ä½¿ã†**âœ…âœ…âœ…<br>
âœ… ãƒ¦ãƒ¼ã‚¶æƒ…å ±å–å¾— -> UserDetailsService\<IF\>.loadUserByUsername é–¢æ•°<br>
âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ -> PasswordEncoder\<IF\>.matches é–¢æ•°<br>
ğŸ”´ ã“ã†è¦‹ã‚‹ã¨...Managerã€Provider ã¯ãŸã ã®é€šéåœ°ç‚¹ã¿ãŸã„ãªæ„Ÿã˜ã€‚

![](https://storage.googleapis.com/zenn-user-upload/867fbf0bcddd-20231103.png)

<details>
<summary>generated by sequencediagram</summary>
LoginPage->Filter:POST /login<br>
Filter->Manager:authenticate(Authentication)<br>
Manager->Provider:authenticate(Authentication)<br>
Provider->UserDetailsService:loadUserByUsername()<br>
UserDetailsService->Provider:UserDetails<br>
Provider->PasswordEncoder:matches()<br>
PasswordEncoder->Provider:OK!<br>
Provider->Manager:Authentication<br>
Manager->Filter:Authentication<br>
Filter->Filter:SecurityContextã«ä¿å­˜<br>
Filter->LoginPage:èªè¨¼OK
</details>

<br>
<br>

# IF -> IMPL

| IF                        | IMPL                                                                                          |
| ------------------------- | --------------------------------------------------------------------------------------------- |
| Filter, GenericFilterBean | UsernamePasswordAuthenticationFilter                                                          |
| AuthenticationManager     | ProviderManager                                                                               |
| AuthenticationProvider    | DaoAuthenticationProvider<br>OpenIDAuthenticationProvider<br>RememberMeAuthenticationProvider |
